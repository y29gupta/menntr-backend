generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////
// ENUMS
//////////////////////

enum institution_status {
  active
  suspended
  cancelled
  trial
}

enum user_status {
  active
  inactive
  suspended
  deleted
}

enum token_type {
  email_verification
  password_reset
  api_key
  session
}

//////////////////////
// CORE TABLES
//////////////////////

model plans {
  id                   Int      @id @default(autoincrement())
  code                 String   @unique
  name                 String
  price_monthly        Decimal?
  price_yearly         Decimal?
  max_students         Int?
  max_admins           Int?
  is_public            Boolean  @default(true)
  description          String?
  storage_gb           Int      @default(1)
  ai_queries_per_month Int      @default(0)
  created_at           DateTime @default(now())

  institutions  institutions[]
  plan_modules  plan_modules[]
  plan_features plan_features[]
}

model modules {
  id               Int      @id @default(autoincrement())
  code             String   @unique
  name             String
  description      String?
  icon             String?
  category         String?
  is_core          Boolean  @default(false)
  is_system_module Boolean  @default(false)
  sort_order       Int      @default(0)
  created_at       DateTime @default(now())

  features            features[]
  plan_modules        plan_modules[]
  institution_modules institution_modules[]
}

model features {
  id                Int      @id @default(autoincrement())
  code              String   @unique
  name              String
  description       String?
  module_id         Int
  min_plan_required String?
  sort_order        Int      @default(0)
  created_at        DateTime @default(now())

  module        modules         @relation(fields: [module_id], references: [id])
  permissions   permissions[]
  plan_features plan_features[]
}

model permissions {
  id              Int      @id @default(autoincrement())
  feature_code    String
  permission_code String   @unique
  permission_name String
  action_type     String?
  description     String?
  created_at      DateTime @default(now())

  feature          features           @relation(fields: [feature_code], references: [code])
  role_permissions role_permissions[]
}

model institutions {
  id            Int                @id @default(autoincrement())
  name          String
  code          String             @unique
  subdomain     String?
  contact_email String
  plan_id       Int?
  status        institution_status @default(active)
  trial_ends_at DateTime?
  metadata      Json               @default("{}")
  created_at    DateTime           @default(now())
  updated_at    DateTime           @updatedAt

  plan                plans?                @relation(fields: [plan_id], references: [id])
  users               users[]
  roles               roles[]
  institution_modules institution_modules[]
  batches             batches[]
}

//////////////////////
// ROLE HIERARCHY
//////////////////////

model role_hierarchy {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  level       Int
  active      Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  roles roles[]
}

//////////////////////
// USERS & ROLES
//////////////////////

model users {
  id                   BigInt      @id @default(autoincrement())
  institution_id       Int?
  email                String
  password_hash        String?
  email_verified       Boolean     @default(false)
  must_change_password Boolean     @default(true)
  first_name           String?
  last_name            String?
  avatar_url           String?
  status               user_status @default(active)
  last_login_at        DateTime?
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt

  institution   institutions?    @relation(fields: [institution_id], references: [id])
  user_roles    user_roles[]
  auth_tokens   auth_tokens[]
  batches       batches[]
  batchStudents batch_students[]

  @@unique([email, institution_id])
}

model roles {
  id                Int      @id @default(autoincrement())
  code              String?
  name              String
  description       String?
  institution_id    Int?
  parent_id         Int?
  role_hierarchy_id Int?
  is_system_role    Boolean  @default(false)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  institution institutions?   @relation(fields: [institution_id], references: [id])
  parent      roles?          @relation("role_parent", fields: [parent_id], references: [id])
  children    roles[]         @relation("role_parent")
  hierarchy   role_hierarchy? @relation(fields: [role_hierarchy_id], references: [id])

  user_roles       user_roles[]
  role_permissions role_permissions[]

  category_batches   batches[] @relation("BatchCategoryRole")
  department_batches batches[] @relation("BatchDepartmentRole")
}

model user_roles {
  user_id     BigInt
  role_id     Int
  assigned_at DateTime @default(now())
  assigned_by BigInt?

  user users @relation(fields: [user_id], references: [id])
  role roles @relation(fields: [role_id], references: [id])

  @@id([user_id, role_id])
}

model auth_tokens {
  id         Int        @id @default(autoincrement())
  user_id    BigInt
  token_hash String
  type       token_type
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime   @default(now())

  user users @relation(fields: [user_id], references: [id])
}

//////////////////////
// JUNCTION TABLES
//////////////////////

model plan_modules {
  plan_id   Int
  module_id Int
  included  Boolean @default(true)

  plan   plans   @relation(fields: [plan_id], references: [id])
  module modules @relation(fields: [module_id], references: [id])

  @@id([plan_id, module_id])
}

model plan_features {
  plan_code    String
  feature_code String
  included     Boolean @default(true)
  usage_limit  Int?

  plan    plans    @relation(fields: [plan_code], references: [code])
  feature features @relation(fields: [feature_code], references: [code])

  @@id([plan_code, feature_code])
}

model institution_modules {
  institution_id Int
  module_id      Int
  enabled        Boolean  @default(true)
  configured_at  DateTime @default(now())

  institution institutions @relation(fields: [institution_id], references: [id])
  module      modules      @relation(fields: [module_id], references: [id])

  @@id([institution_id, module_id])
}

model role_permissions {
  role_id       Int
  permission_id Int

  role       roles       @relation(fields: [role_id], references: [id])
  permission permissions @relation(fields: [permission_id], references: [id])

  @@id([role_id, permission_id])
}

model batches {
  id             Int    @id @default(autoincrement())
  institution_id Int
  name           String
  code           String

  // Role hierarchy links
  category_role_id   Int?
  department_role_id Int

  // Academic info
  academic_year Int
  semester      Int?
  start_date    DateTime?
  end_date      DateTime?

  // Coordinator (Faculty)
  coordinator_id BigInt?

  metadata  Json    @default("{}")
  is_active Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  institution institutions @relation(fields: [institution_id], references: [id])

  category_role   roles? @relation("BatchCategoryRole", fields: [category_role_id], references: [id])
  department_role roles  @relation("BatchDepartmentRole", fields: [department_role_id], references: [id])

  coordinator users? @relation(fields: [coordinator_id], references: [id])

  students batch_students[]

  @@unique([institution_id, code])
}

model batch_students {
  batch_id        Int
  student_id      BigInt
  enrollment_date DateTime @default(now())
  roll_number     String?
  is_active       Boolean  @default(true)
  metadata        Json     @default("{}")

  batch   batches @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  student users   @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@id([batch_id, student_id])
}
