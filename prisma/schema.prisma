generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserStatus {
  active
  invited
  disabled
}

enum TokenType {
  one_time_login
  refresh
}

enum InstitutionStatus {
  active
  trial
  suspended
}

/**
 * =========================
 * CORE MODELS
 * =========================
 */

model User {
  id                 BigInt     @id @default(autoincrement())
  email              String
  passwordHash       String?
  firstName          String?
  lastName           String?
  avatarUrl          String?
  status             UserStatus @default(active)
  mustChangePassword Boolean    @default(true)
  emailVerified      Boolean    @default(false)
  lastLoginAt        DateTime?
  institutionId      Int?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  institution Institution? @relation(fields: [institutionId], references: [id])
  roles       UserRole[]
  authTokens  AuthToken[]

  @@unique([email, institutionId])
  @@index([email])
}

model Institution {
  id           Int               @id @default(autoincrement())
  name         String
  code         String            @unique
  subdomain    String?
  contactEmail String
  status       InstitutionStatus @default(active)
  planId       Int?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  plan  Plan?  @relation(fields: [planId], references: [id])
  users User[]
  roles Role[]
}

model Role {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?
  isSystemRole  Boolean  @default(false)
  institutionId Int?
  parentId      Int?
  createdAt     DateTime @default(now())

  institution Institution? @relation(fields: [institutionId], references: [id])
  parent      Role?        @relation("RoleTree", fields: [parentId], references: [id])
  children    Role[]       @relation("RoleTree")
  users       UserRole[]

  @@index([institutionId])
}

model UserRole {
  userId     BigInt
  roleId     Int
  assignedBy BigInt?
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model AuthToken {
  id        Int       @id @default(autoincrement())
  userId    BigInt
  tokenHash String
  type      TokenType
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([expiresAt])
}

model Plan {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  priceMonthly Decimal?
  priceYearly  Decimal?
  maxStudents  Int?
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())

  institutions Institution[]
}
